<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BV Iberia Executive Dashboard - Jan 2026</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js & Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        :root {
            --bv-navy: #00049E;
            --bv-turquoise: #00AEC7;
            --bv-grey-bg: #f4f7fa;
            --bv-white: #FFFFFF;
            --pastel-green: #A5D6A7;
            --pastel-red: #EF9A9A;
            --text-dark: #2D3748;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background-color: var(--bv-grey-bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-dark);
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bv-navy);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .logo-area {
            margin-bottom: 40px;
            text-align: center;
        }

        .logo-area img {
            max-width: 150px;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            opacity: 0.8;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            opacity: 1;
            font-weight: 600;
            border-left: 4px solid var(--bv-turquoise);
        }

        .nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--bv-navy);
        }

        .date-pill {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            color: var(--bv-navy);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        /* LAYOUT UTILS */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .charts-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* CARDS */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--bv-navy);
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        /* KPI CARDS */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid var(--bv-navy);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .kpi-val {
            font-size: 26px;
            font-weight: 800;
            color: #2D3748;
            margin: 5px 0;
        }

        .kpi-lbl {
            font-size: 11px;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
        }

        .kpi-sub {
            font-size: 11px;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        .badge {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }

        .bg-green {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .bg-red {
            background: #FFEBEE;
            color: #C62828;
        }

        .text-red {
            color: #C62828;
        }

        .text-green {
            color: #2E7D32;
        }

        /* FILTER BUTTONS (DETAIL VIEW) */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-dark);
            transition: 0.2s;
        }

        .filter-btn:hover {
            background: #f0f4f8;
        }

        .filter-btn.active {
            background: var(--bv-navy);
            color: white;
            border-color: var(--bv-navy);
        }

        /* P&L SPECIFIC LAYOUT */
        .pnl-layout {
            display: grid;
            grid-template-columns: 2.5fr 1fr;
            /* Table wider */
            gap: 20px;
            align-items: start;
        }

        .table-wrapper {
            background: white;
            border-radius: 10px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: var(--bv-navy);
            color: white;
            padding: 12px;
            text-align: right;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        th:first-child {
            text-align: left;
        }

        td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }

        td:first-child {
            text-align: left;
            font-weight: 600;
            color: var(--bv-navy);
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        tr.active-row {
            background-color: #e0f2fe;
            border-left: 4px solid var(--bv-turquoise);
        }

        /* INSIGHTS PANEL */
        .insights-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            height: 100%;
            min-height: 400px;
        }

        .insight-content {
            font-size: 13px;
            line-height: 1.6;
            color: #444;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--bv-turquoise);
            margin-top: 15px;
        }

        /* PERIMETER FOCUS */
        .perimeter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .perim-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid var(--bv-turquoise);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            position: relative;
        }
    </style>
</head>

<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="logo-area">
            <img src="https://jrisueno74.github.io/RESOURCES_BV/LOGO%20WHITE.png" alt="BV Logo">
        </div>
        <div class="nav-item active" onclick="showView('summary', this)">
            <i class="fas fa-chart-pie"></i> Executive Summary
        </div>
        <div class="nav-item" onclick="showView('detail', this)">
            <i class="fas fa-sitemap"></i> Product Line Detail
        </div>
        <div class="nav-item" onclick="showView('ad50', this)">
            <i class="fas fa-file-invoice-dollar"></i> P&L Analysis (AD50)
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">

        <div class="header">
            <div>
                <h1>Performance Dashboard</h1>
                <span>Iberia Region • Executive Committee</span>
            </div>
            <div class="date-pill">
                <i class="far fa-calendar"></i> January 2026
            </div>
        </div>

        <!-- VIEW 1: EXECUTIVE SUMMARY -->
        <div id="view-summary" class="view-section active">

            <!-- Global KPIs -->
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-lbl">Sales MTD</div>
                    <div class="kpi-val">28.955 k€</div>
                    <div class="kpi-sub">
                        <span class="badge bg-green">VB +2.931 k€</span>
                        <span class="text-green">+10.8k VLY</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">Revenue MTD</div>
                    <div class="kpi-val">12.634 k€</div>
                    <div class="kpi-sub">
                        <span class="badge bg-red">VB -696 k€</span>
                        <span class="text-red">OG: -1.4%</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">Adj. Op. Profit</div>
                    <div class="kpi-val text-red">-162 k€</div>
                    <div class="kpi-sub">
                        <span class="badge bg-red">VB -809 k€</span>
                        <span class="text-green">VLY +569</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">Prod Margin %</div>
                    <div class="kpi-val text-red">-1.3%</div>
                    <div class="kpi-sub">
                        <span class="badge bg-red">-610 bps VB</span>
                        <span class="text-green">+661 bps VLY</span>
                    </div>
                </div>
            </div>

            <!-- ROW 2: SALES & REV VARIANCE -->
            <div class="charts-row-2">
                <div class="card">
                    <div class="card-title">Sales Variance vs Budget (k€)</div>
                    <div style="height: 250px;">
                        <canvas id="salesVarChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Revenue Variance vs Budget (k€)</div>
                    <div style="height: 250px;">
                        <canvas id="revVarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ROW 3: OP VAR -->
            <div class="card" style="margin-bottom:20px;">
                <div class="card-title">Adj. Operating Profit Variance vs Budget (k€)</div>
                <div style="height: 250px;">
                    <canvas id="opVarChart"></canvas>
                </div>
            </div>

            <!-- REMOVED BENCHMARKS HERE AS REQUESTED -->

            <!-- SPECIFIC PERIMETER FOCUS -->
            <h3 style="font-size:14px; color:#888; margin-bottom:10px; text-transform:uppercase;">Specific Perimeter
                Focus</h3>
            <div class="perimeter-grid">
                <div class="perim-card">
                    <div class="kpi-lbl" style="color:var(--bv-navy);">IDP TOTAL</div>
                    <div class="kpi-val" style="font-size:20px;">2.562 k€ <span
                            style="font-size:12px; color:#777; font-weight:400;">Rev</span></div>
                    <div class="kpi-sub">
                        <span class="badge bg-red" title="Rev Var">-24 VB</span>
                        <span style="font-weight:700;">OP: 343 k€ <span class="text-green" style="font-size:10px">(+22
                                VB)</span></span>
                    </div>
                </div>
                <div class="perim-card">
                    <div class="kpi-lbl" style="color:var(--bv-navy);">PORTUGAL</div>
                    <div class="kpi-val" style="font-size:20px;">901 k€ <span
                            style="font-size:12px; color:#777; font-weight:400;">Rev</span></div>
                    <div class="kpi-sub">
                        <span class="badge bg-green" title="Rev Var">+14 VB</span>
                        <span style="font-weight:700;">OP: -7 k€ <span class="text-red" style="font-size:10px">(-27
                                VB)</span></span>
                    </div>
                </div>
                <div class="perim-card">
                    <div class="kpi-lbl" style="color:var(--bv-navy);">SOLIDA</div>
                    <div class="kpi-val" style="font-size:20px;">1.181 k€ <span
                            style="font-size:12px; color:#777; font-weight:400;">Rev</span></div>
                    <div class="kpi-sub">
                        <span class="badge bg-green" title="Rev Var">+66 VB</span>
                        <span style="font-weight:700;">OP: -199 k€ <span class="text-red" style="font-size:10px">(-245
                                VB)</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: PRODUCT LINE DETAIL -->
        <div id="view-detail" class="view-section">
            <div class="filter-bar">
                <button class="filter-btn active" onclick="loadDetail('IBERIA', this)">IBERIA</button>
                <button class="filter-btn" onclick="loadDetail('IND', this)">INDUSTRY</button>
                <button class="filter-btn" onclick="loadDetail('BIC', this)">B&I CAPEX</button>
                <button class="filter-btn" onclick="loadDetail('BIO', this)">B&I OPEX</button>
                <button class="filter-btn" onclick="loadDetail('CER', this)">CERTIFICATION</button>
                <button class="filter-btn" onclick="loadDetail('AFC', this)">AFC</button>
            </div>

            <div class="charts-row-2">
                <!-- Sub-Product Line Variance Chart -->
                <div class="card">
                    <div class="card-title">Revenue Variance vs Budget (k€)</div>
                    <div style="height: 250px;">
                        <canvas id="detailRevChart"></canvas>
                    </div>
                </div>
                <!-- Sub-Product Line OP Chart -->
                <div class="card">
                    <div class="card-title">Operating Profit Variance vs Budget (k€)</div>
                    <div style="height: 250px;">
                        <canvas id="detailOpChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="charts-row-2">
                <div class="card">
                    <div class="card-title">Organic Growth % Benchmark</div>
                    <div style="height: 250px;">
                        <canvas id="detailOgChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Margin % Benchmark</div>
                    <div style="height: 250px;">
                        <canvas id="detailMarginChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: AD50 P&L ANALYSIS -->
        <div id="view-ad50" class="view-section">
            <div class="pnl-layout">

                <!-- Left Column: Table -->
                <div class="card" style="padding:0; overflow:hidden;">
                    <div class="card-title" style="margin:20px;">Detailed P&L Variance (k€)</div>
                    <div class="table-wrapper" style="box-shadow:none;">
                        <table id="plTable">
                            <thead>
                                <tr>
                                    <th>P&L Line Item</th>
                                    <th>Actual MTD</th>
                                    <th>Var VB</th>
                                    <th>IND</th>
                                    <th>BIC</th>
                                    <th>BIO</th>
                                    <th>CER</th>
                                    <th>AFC</th>
                                    <th style="background:#f0f4f8; color:#333;">IDP</th>
                                    <th style="background:#f0f4f8; color:#333;">SOL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Generated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Column: Waterfall & Insights -->
                <div style="display:flex; flex-direction:column; gap:20px;">

                    <!-- Waterfall Chart -->
                    <div class="card">
                        <div class="card-title">Variance Waterfall (k€)</div>
                        <div style="height: 200px;">
                            <canvas id="plWaterfall"></canvas>
                        </div>
                    </div>

                    <!-- Insights Panel -->
                    <div class="card insights-panel">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <i class="fas fa-list-ul" style="color:var(--bv-turquoise); font-size:18px;"></i>
                            <h4 style="color:var(--bv-navy); font-weight:700; margin:0;">AI Executive Insights</h4>
                        </div>
                        <div id="insight-container">
                            <div style="color:#999; font-style:italic; text-align:center; margin-top:50px;">
                                Select a line in the P&L table to view analysis.
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // Register Plugin
        Chart.register(ChartDataLabels);

        // --- 1. DATASETS (January 2026) ---
        // MAIN PRODUCT LINES
        const plLabels = ['IND', 'BIC', 'BIO', 'CER', 'AFC'];
        const revVbData = [23, 17, -631, -53, -51];
        const opVbData = [-350, -30, -511, 168, -85];
        const salesVbData = [909, 941, 1291, -164, -45];

        // SUB-PRODUCT DATA (For Detail Tab)
        // Includes 'IBERIA' as a special key for the aggregated view
        const subPlData = {
            'IBERIA': {
                labels: ['INDUSTRY', 'B&I CAPEX', 'B&I OPEX', 'CERTIFICATION', 'AFC'],
                revVar: [23, 17, -631, -53, -51],
                opVar: [-350, -30, -511, 168, -85],
                margin: [-10.4, 10.6, -10.7, 6.0, -31.1],
                og: [17.7, -7.2, -5.8, 5.0, -25.3]
            },
            'IND': {
                labels: ['Ind Capex', 'INC', 'Ind Opex', 'Ind Cert', 'Solida'],
                revVar: [82, 16, -4, -55, 66],
                opVar: [-152, 47, -110, -48, -199],
                margin: [-9.9, 13.5, -13.0, -7.9, -16.7],
                og: [165.1, 165.1, 20.3, -13.5, 0]
            },
            'BIC': {
                labels: ['BIC', 'IDP', 'ECO'],
                revVar: [41, 133, -157],
                opVar: [48, 238, 105],
                margin: [4.2, 17.5, 8.8],
                og: [2.1, -19.1, 0.8]
            },
            'BIO': {
                labels: ['ESG', 'HSE', 'ENV', 'ISV'],
                revVar: [44, -48, -203, -424],
                opVar: [-35, -87, -28, -170],
                margin: [-18.8, -21.6, -3.7, -10.2],
                og: [81.5, 17.5, -4.8, -15.1]
            },
            'CER': {
                labels: ['Certification', 'Training', 'Cyber'],
                revVar: [-48, -5, -1],
                opVar: [191, -29, 0],
                margin: [8.5, -6.2, 73.9],
                og: [3.7, 10.8, -105.9]
            },
            'AFC': {
                labels: ['AFC Total'],
                revVar: [-51],
                opVar: [-85],
                margin: [-31.1],
                og: [-25.3]
            }
        };

        // P&L DATA
        const plRows = [
            {
                name: '01 Revenue',
                actual: 12634, var: -696,
                ind: 23, bic: 17, bio: -631, cer: -53, afc: -51, idp: -24, sol: 66,
                detail: "<strong>Revenue Gap Analysis (-€631k VB):</strong><br>• <strong>B&I Opex (ISV):</strong> -€424k. Catalonia region accounts for -€422k driven by 3 voluntary departures, 2 sick leaves, and legionella training downtime.<br>• <strong>B&I Opex (ENV):</strong> -€203k due to 5 vacancies vs 2025. <br><em>Action Plan:</em> Hiring prioritized for Feb/Mar; daily planning controls in place."
            },
            {
                name: '02 Group Cont / Serv',
                actual: 19, var: -81,
                ind: -76, bic: -25, bio: 21, cer: 31, afc: -32, idp: -8, sol: -41,
                detail: "<strong>IPC:</strong> -€45k variance, fully offset by savings in Subcontracting (ENV +€45k)."
            },
            {
                name: 'Total Production',
                actual: 12653, var: -777,
                ind: -53, bic: -7, bio: -610, cer: -23, afc: -84, idp: -31, sol: 25,
                detail: "Production value tracks Revenue dip. No significant productivity loss, merely volume-driven."
            },
            {
                name: 'Total 03 Other Direct',
                actual: 135, var: 44,
                ind: 34, bic: 57, bio: 4, cer: -47, afc: -3, idp: 67, sol: 50,
                detail: "<strong>CER:</strong> -€41k VB due to contract losses (CAM CEAF4 -€10k, QHSE Portugal -€22k).<br><strong>BIO ESG:</strong> -€56k due to HS101 Mercadona contract timing."
            },
            {
                name: 'Total 04 Ext. Subcon',
                actual: -1575, var: -212,
                ind: -353, bic: 108, bio: -50, cer: 92, afc: -9, idp: 153, sol: -378,
                detail: "<strong>ESG:</strong> Mercadona contract impact.<br><strong>HO IPC:</strong> -€34k variance.<br><strong>BIC:</strong> Variance linked to higher production volume."
            },
            {
                name: 'Total 05 Personnel',
                actual: -7344, var: -177,
                ind: -138, bic: -36, bio: 14, cer: -18, afc: 1, idp: -36, sol: -145,
                detail: "<strong>Solida:</strong> Personnel costs exceed budget.<br><strong>IDP:</strong> -€50k due to unbudgeted incentive payouts.<br><strong>Recruitment:</strong> Headhunter costs -€22k."
            },
            {
                name: 'Total 06 Travel',
                actual: -684, var: 132,
                ind: 42, bic: -17, bio: 66, cer: 39, afc: 2, idp: -22, sol: 41,
                detail: "<strong>Savings:</strong> +€132k positive variance, likely due to budget calendarization differences (delayed travel vs plan)."
            },
            {
                name: 'Total 08 Other Indirect',
                actual: -905, var: -107,
                ind: -53, bic: -116, bio: -21, cer: 68, afc: 14, idp: -91, sol: -26,
                detail: "<strong>IDP:</strong> -€63k IFRS16 impact; +€9k canteen provision recovery.<br><strong>ECO:</strong> Vehicle write-off -€13k.<br><strong>TRG:</strong> Duplicate IT costs in budget (+€15k)."
            },
            {
                name: 'Total 10 HO Fees',
                actual: -470, var: 18,
                ind: -1, bic: 0, bio: 15, cer: 2, afc: 2, idp: 1, sol: -2,
                detail: "In line with budget."
            },
            {
                name: 'Total 11 Functional',
                actual: -1713, var: 309,
                ind: 162, bic: 20, bio: 80, cer: 57, afc: -10, idp: 32, sol: 187,
                detail: "<strong>Positive Impact:</strong> Recovery of Q4 commercial incentives provision (+€32k). Total functional savings impact +€50k."
            },
            {
                name: 'Operating Profit',
                actual: -162, var: -810,
                ind: -351, bic: -30, bio: -511, cer: 168, afc: -85, idp: 22, sol: -245,
                detail: "<strong>Final Result (-€162k):</strong> Critical deviation vs Budget (-€810k).<br>Driven by B&I Opex revenue miss (-€511k impact) and Industry subcontracting/opex (-€351k impact).<br>Certification remains the only positive performer (+€168k)."
            }
        ];

        // --- 2. CHART CONFIG ---
        const cGreen = '#A5D6A7';
        const cRed = '#EF9A9A';
        const colorizer = (ctx) => ctx.raw >= 0 ? cGreen : cRed;

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: '#444',
                    anchor: 'end',
                    align: 'end',
                    font: { weight: 'bold', size: 10 },
                    formatter: (val) => Math.round(val)
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                x: { grid: { display: false } }
            }
        };

        // --- 3. INIT ---
        window.onload = function () {
            renderSummaryCharts();
            renderPnlTable();
            // Default Detail View: IBERIA
            loadDetail('IBERIA', document.querySelector('.filter-bar .filter-btn'));
            // Default Waterfall
            renderWaterfall([-696, -81, -212, -177, 132, -107, 309, -810], ['Rev', 'Prod', 'Subc', 'Pers', 'Trav', 'Indir', 'Func', 'OP']);
        };

        // --- 4. SUMMARY VIEW RENDER ---
        function renderSummaryCharts() {
            new Chart(document.getElementById('salesVarChart'), {
                type: 'bar',
                data: { labels: plLabels, datasets: [{ data: salesVbData, backgroundColor: colorizer, borderRadius: 4 }] },
                options: commonOptions
            });

            new Chart(document.getElementById('revVarChart'), {
                type: 'bar',
                data: { labels: plLabels, datasets: [{ data: revVbData, backgroundColor: colorizer, borderRadius: 4 }] },
                options: commonOptions
            });

            new Chart(document.getElementById('opVarChart'), {
                type: 'bar',
                data: { labels: plLabels, datasets: [{ data: opVbData, backgroundColor: colorizer, borderRadius: 4 }] },
                options: commonOptions
            });
        }

        // --- 5. DETAIL VIEW LOGIC ---
        let detailCharts = {};

        function loadDetail(plKey, btn) {
            if (btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            const data = subPlData[plKey];

            // Render 4 charts
            renderDetailChart('detailRevChart', 'Revenue Var (k€)', data.labels, data.revVar, false);
            renderDetailChart('detailOpChart', 'OP Var (k€)', data.labels, data.opVar, false);

            // Sort Benchmarks for Detail View
            const sortedOg = sortData(data.labels, data.og);
            renderDetailChart('detailOgChart', 'OG %', sortedOg.labels, sortedOg.data, true);

            const sortedMargin = sortData(data.labels, data.margin);
            renderDetailChart('detailMarginChart', 'Margin %', sortedMargin.labels, sortedMargin.data, true);
        }

        function renderDetailChart(canvasId, label, labels, data, isPercent) {
            if (detailCharts[canvasId]) detailCharts[canvasId].destroy();

            const ctx = document.getElementById(canvasId).getContext('2d');
            detailCharts[canvasId] = new Chart(ctx, {
                type: 'bar',
                // Use horizontal for benchmarks (percent), vertical for variance
                indexAxis: isPercent ? 'y' : 'x',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(v => v >= 0 ? cGreen : cRed),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: isPercent ? 'y' : 'x',
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#444',
                            anchor: 'end',
                            align: 'end',
                            font: { weight: 'bold', size: 10 },
                            formatter: (val) => isPercent ? val.toFixed(1) + '%' : Math.round(val)
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Helper: Sort Data
        function sortData(labels, data) {
            let combined = labels.map((l, i) => ({ label: l, val: data[i] }));
            combined.sort((a, b) => b.val - a.val);
            return {
                labels: combined.map(i => i.label),
                data: combined.map(i => i.val)
            };
        }

        // --- 6. P&L LOGIC ---
        let waterfallChart;

        function renderPnlTable() {
            const tbody = document.querySelector('#plTable tbody');
            tbody.innerHTML = ''; // Clear existing rows

            // 1. Calculate Max Variance for Scaling
            let maxVar = 0;
            plRows.forEach(row => {
                // Check all variance columns: Var VB, IND, BIC, BIO, CER, AFC, IDP, SOL
                const values = [row.var, row.ind, row.bic, row.bio, row.cer, row.afc, row.idp, row.sol];
                values.forEach(v => {
                    const absV = Math.abs(v);
                    if (absV > maxVar) maxVar = absV;
                });
            });

            // 2. Render Rows
            plRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.onclick = () => handleRowClick(row, tr);

                // Helper to get cell style
                const getStyle = (val) => {
                    const absVal = Math.abs(val);
                    // Calculate intensity (0.1 to 1.0) based on maxVar
                    // We use a non-linear scale (sqrt) to make smaller variances more visible, or linear?
                    // Let's use linear for "economic impact" accuracy.
                    let param = maxVar > 0 ? (absVal / maxVar) : 0;
                    // Cap at 1.0
                    if (param > 1) param = 1;

                    // Highlight logic:
                    // Positive (Good) = Green (Cost: Negative is Bad, Positive is Good; Revenue: Positive is Good)
                    // We assume standard variance: + is Good, - is Bad.
                    // Green: 165, 214, 167 (Pastel Green #A5D6A7) -> rgb(165, 214, 167)
                    // Red: 239, 154, 154 (Pastel Red #EF9A9A) -> rgb(239, 154, 154)

                    // We will use rgba for background to control intensity
                    // But to keep the "pastel" look consistent and just vary saturation, 
                    // maybe mix with white?
                    // Actually, opacity on a solid background of the row (white/grey) works well.

                    const isPositive = val >= 0;
                    const baseColor = isPositive ? '165, 214, 167' : '239, 154, 154';
                    // Min opacity 0.15 to show *some* color, Max 1.0
                    const alpha = 0.15 + (0.85 * param);

                    const bgColor = `rgba(${baseColor}, ${alpha.toFixed(2)})`;
                    const textColor = '#2D3748'; // Dark text for readability

                    return `background-color: ${bgColor}; color: ${textColor}; font-weight: 600; border-radius: 4px;`;
                };

                // Format numbers
                const fmt = (n) => n.toLocaleString();

                tr.innerHTML = `
                    <td style="font-weight:600; color:var(--bv-navy);">${row.name}</td>
                    <td>${fmt(row.actual)}</td>
                    <td style="${getStyle(row.var)}">${row.var > 0 ? '+' : ''}${fmt(row.var)}</td>
                    <td style="${getStyle(row.ind)}">${fmt(row.ind)}</td>
                    <td style="${getStyle(row.bic)}">${fmt(row.bic)}</td>
                    <td style="${getStyle(row.bio)}">${fmt(row.bio)}</td>
                    <td style="${getStyle(row.cer)}">${fmt(row.cer)}</td>
                    <td style="${getStyle(row.afc)}">${fmt(row.afc)}</td>
                    <td style="${getStyle(row.idp)}">${fmt(row.idp)}</td>
                    <td style="${getStyle(row.sol)}">${fmt(row.sol)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function handleRowClick(row, trElement) {
            document.querySelectorAll('#plTable tr').forEach(r => r.classList.remove('active-row'));
            if (trElement) trElement.classList.add('active-row');

            let labels, data;
            if (row.name.includes('Operating Profit')) {
                labels = ['Rev', 'Prod', 'Subc', 'Pers', 'Indir', 'Func', 'OP'];
                data = [-696, -81, -212, -177, -107, 309, -810];
            } else {
                labels = ['IND', 'BIC', 'BIO', 'CER', 'AFC'];
                data = [row.ind, row.bic, row.bio, row.cer, row.afc];
            }
            renderWaterfall(data, labels);

            const insightContainer = document.getElementById('insight-container');
            insightContainer.innerHTML = `
                <div class="insight-content">
                    <strong style="color:var(--bv-navy); font-size:14px; text-transform:uppercase;">${row.name}</strong>
                    <div style="margin-top:10px; font-size:12px;">
                        ${row.detail}
                    </div>
                </div>
            `;
        }

        function renderWaterfall(data, labels) {
            const ctx = document.getElementById('plWaterfall').getContext('2d');
            if (waterfallChart) waterfallChart.destroy();

            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(v => v >= 0 ? cGreen : cRed),
                        borderRadius: 4
                    }]
                },
                options: commonOptions
            });
        }

        // View Navigation
        function showView(id, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            if (btn) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                btn.classList.add('active');
            }
        }
    </script>
</body>

</html>